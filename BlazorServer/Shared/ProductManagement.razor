@page "/product-management"
@using BlazorServer.Data
@using System.Net.Http.Json
@using System.Text.Json;

@inject HttpClient httpClient
@inject NavigationManager navigationManager

<h3>Product Management</h3>

@if (products != null && products.Count > 0)
{
    <table class="table">
        <thead>
            <tr>
                <th>Serial Number</th>
                <th>Amount</th>
                <th>Product Name</th>
                <th>Product Description</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var product in products)
            {
                <tr>
                    <td>@product.SerialNumber</td>
                    <td>@product.Amount</td>
                    <td>@product.ProductName</td>
                    <td>@product.ProductDescription</td>
                    <td>
                        <button class="btn btn-primary btn-sm" @onclick="() => EditProduct(product)">Edit</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <p>No products found.</p>
}

<button class="btn btn-success" @onclick="ShowAddProductForm">Add Product</button>

@if (showAddProductForm)
{
    <h4>Add New Product</h4>

    <div class="form-group">
        <label for="amount">Amount</label>
        <input class="form-control" id="amount" @bind="@newProduct.Amount" />
    </div>

    <div class="form-group">
        <label for="productName">Product Name</label>
        <input class="form-control" id="productName" @bind="@newProduct.ProductName" />
    </div>

    <div class="form-group">
        <label for="productDescription">Product Description</label>
        <input class="form-control" id="productDescription" @bind="@newProduct.ProductDescription" />
    </div>

    <button class="btn btn-primary" @onclick="AddProduct">Save</button>
}

@if (editingProduct != null)
{
    <h4>Edit Product</h4>

    <div class="form-group">
        <label for="editAmount">Amount</label>
        <input class="form-control" id="editAmount" @bind="@editingProduct.Amount" />
    </div>

    <div class="form-group">
        <label for="editProductName">Product Name</label>
        <input class="form-control" id="editProductName" @bind="@editingProduct.ProductName" />
    </div>

    <div class="form-group">
        <label for="editProductDescription">Product Description</label>
        <input class="form-control" id="editProductDescription" @bind="@editingProduct.ProductDescription" />
    </div>

    <button class="btn btn-primary" @onclick="SaveProductChanges">Save Changes</button>
}

@code {
    private List<Product> products;
    private Product editingProduct;
    private Product newProduct = new Product();
    private bool showAddProductForm = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadProducts();
    }

    private async Task LoadProducts()
    {
        HttpResponseMessage response = await httpClient.GetAsync("https://localhost:7134/api/Stock");

        if (response.IsSuccessStatusCode)
        {
            string json = await response.Content.ReadAsStringAsync();
            products = JsonSerializer.Deserialize<List<Product>>(json, new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
        }
        else
        {
            // Handle the error when retrieving products (e.g., display an error message)
        }
    }

    private void ShowAddProductForm()
    {
        showAddProductForm = true;
    }

    private async Task AddProduct()
    {
        HttpResponseMessage response = await httpClient.PostAsJsonAsync("https://localhost:7134/api/Stock", newProduct);

        if (response.IsSuccessStatusCode)
        {
            var createdProduct = await response.Content.ReadFromJsonAsync<Product>();
            if (createdProduct != null)
            {
                newProduct = new Product(); // Reset the new product form
                await LoadProducts(); // Reload the products
            }
            else
            {
                // Handle error
            }
        }
        else
        {
            // Handle error
        }
    }

    private void EditProduct(Product product)
    {
        editingProduct = new Product
            {
                SerialNumber = product.SerialNumber,
                Amount = product.Amount,
                ProductName = product.ProductName,
                ProductDescription = product.ProductDescription
            };
    }

    private async Task SaveProductChanges()
    {
        if (editingProduct != null)
        {
            // Update existing product
            HttpResponseMessage response = await httpClient.PutAsJsonAsync($"https://localhost:7134/api/Stock/{editingProduct.SerialNumber}", editingProduct);
            if (response.IsSuccessStatusCode)
            {
                await LoadProducts();
                editingProduct = null;
            }
            else
            {
                // Handle error
            }
        }
        else if (newProduct != null)
        {
            // Add new product
            HttpResponseMessage response = await httpClient.PostAsJsonAsync("https://localhost:7134/api/Stock", newProduct);
            if (response.IsSuccessStatusCode)
            {
                var createdProduct = await response.Content.ReadFromJsonAsync<Product>();
                if (createdProduct != null)
                {
                    products.Add(createdProduct); // Add the new product to the products list
                    newProduct = new Product(); // Reset the new product form
                    navigationManager.NavigateTo(navigationManager.Uri, true); // Refresh the page
                }
                else
                {
                    // Handle error
                }
            }
            else
            {
                // Handle error
            }
        }
    }
}